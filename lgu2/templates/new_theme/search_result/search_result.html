{% extends "new_theme/base.html" %}
{% load custom_filters %}
{% load static %}
{% load i18n %}

{% block content %}
<main class="search-results">
	<section>
		<hgroup>
			<h1 id="main-content-h" tabindex="-1">We found {{meta_data.counts.total}} documents</h1>
			<p>
				{% for key, value in meta_data.query.items %}
					<a href='?{{modified_query_links|dict_key:key}}'><span>{{key}}: {{value}}</span></a>
				{% endfor %}
			</p>
		</hgroup>
	</section>

	{% include "new_theme/search_result/bar_graph.html" %}

	<section class="search-content">
		{% include "new_theme/search_result/left_filter.html" %}

		<div class="search-header">
			<div class="sort-by">
				<form method="get" action="{% url 'search' %}">
					<!-- Preserve existing query parameters -->
					{% for key, value in query_param.items %}
						{% if key != 'sort' %}
							<input type="hidden" name="{{key}}" value="{{value}}">
						{% endif %}					
					{% endfor %}

					<label for="sort">Sort by:</label>
					<select id="sort" name="sort" onchange="this.form.submit()">
						<option value="">Select Sort</option>
						<option {% if meta_data.query.sort|lower == 'relevance' %} selected {% endif %} value="relevance">Best match</option>
						<option value="year_asc">Earliest year first</option>
						<option {% if meta_data.query.sort|lower == 'year' %} selected {% endif %} value="year">Latest year first</option>
						<option {% if meta_data.query.sort|lower == 'title' %} selected {% endif %} value="title">Title A-Z</option>
						<option value="title_desc">Title Z-A</option>
						<option value="number_asc">Lowest no. first</option>
						<option value="number">Highest no. first</option>
					</select>
				</form>
			</div>
			{% include "new_theme/search_result/pagination_top_bottom.html" %}
		</div>

		<div class="search-results-list">
			<h2 id="search-results-h" tabindex="-1">Search results</h2>
			<ul class="skip-links">
				<li><a href="#search-filters-h">Skip to search filters</a></li>
			</ul>

			{% if current_subject %}
				{% for subject, documents in grouped_documents.items %}
					{% if subject_heading %}
						{% if subject_heading == subject %}

						<h3>{{ subject }}</h3>
						<ul>
							{% for result in documents %}
								<li>
									<a href="{{ result.link }}">{{ result.title }}</a>
									<span>{{ result.cite }}</span>
									{% with result.longType|camel_to_words as converted_type %}
										<span>{{ converted_type.label_type }}</span>
									{% endwith %}
								</li>
							{% endfor %}
						</ul>
						{% endif %}
					{% else %}
						{% if subject|slice:":1" == current_subject|upper %}
						<h3>{{ subject }}</h3>
						<ul>
							{% for result in documents %}
								<li>
									<a href="{{ result.link }}">{{ result.title }}</a>
									<span>{{ result.cite }}</span>
									{% with result.longType|camel_to_words as converted_type %}
										<span>{{ converted_type.label_type }}</span>
									{% endwith %}
								</li>
							{% endfor %}
						</ul>
						{% endif %}
					{% endif %}
				{% endfor %}
			{% else %}
				<ul>
					{% for result in documents_data %}
						<li>
							<a href="{{ result.link }}">{{ result.title }}</a>
							<span>{{ result.cite }}</span>
							{% with result.longType|camel_to_words as converted_type %}
								<span>{{ converted_type.label_type }}</span>
							{% endwith %}
						</li>
					{% endfor %}
				</ul>
			{% endif %}

			<ul class="skip-links">
				<li><a href="#search-filters-h">Skip to search filters</a></li>
			</ul>
		</div>


		<div class="search-footer">
			<div class="results-count">{{meta_data.counts.total}} results</div>
			
			{% include "new_theme/search_result/pagination_top_bottom.html" %}
			<form role="search" method="get" action="{% url 'search' %}">
			<div class="results-per-page">
				<label for="resultsPerPage">Results per page:</label>
				{% for key, value in query_param.items %}
					{% if key != 'pageSize' %}
						<input type="hidden" name="{{key}}" value="{{value}}">
					{% endif %}
				{% endfor %}
				<input type="number" name="pageSize" value="{{default_pagesize}}" id="resultsPerPage">
				<button type="submit">Go</button>
			</div>
			</form>
		</div>
	</section>
</main>
{% endblock %}